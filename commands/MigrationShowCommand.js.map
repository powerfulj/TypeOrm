{"version":3,"sources":["../../src/commands/MigrationShowCommand.ts"],"names":[],"mappings":";;;AAAA,kCAA0C;AAC1C,iFAA8E;AAE9E,iCAAmC;AAEnC,IAAM,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;AAE/B;;GAEG;AACH;IAAA;QAEE,YAAO,GAAG,gBAAgB,CAAC;QAC3B,aAAQ,GAAG,2DAA2D,CAAC;IA+CzE,CAAC;IA7CC,sCAAO,GAAP,UAAQ,IAAgB;QACtB,OAAO,IAAI;aACR,MAAM,CAAC,YAAY,EAAE;YACpB,KAAK,EAAE,GAAG;YACV,OAAO,EAAE,SAAS;YAClB,QAAQ,EAAE,8CAA8C;SACzD,CAAC;aACD,MAAM,CAAC,QAAQ,EAAE;YAChB,KAAK,EAAE,GAAG;YACV,OAAO,EAAE,WAAW;YACpB,QAAQ,EAAE,iDAAiD;SAC5D,CAAC,CAAC;IACP,CAAC;IAEK,sCAAO,GAAb,UAAc,IAAqB;;;;;;wBAC7B,UAAU,GAAyB,SAAS,CAAC;;;;wBAEzC,uBAAuB,GAAG,IAAI,iDAAuB,CAAC;4BAC1D,IAAI,EAAE,OAAO,CAAC,GAAG,EAAE;4BACnB,UAAU,EAAE,IAAI,CAAC,MAAa;yBAC/B,CAAC,CAAC;wBACuB,qBAAM,uBAAuB,CAAC,GAAG,CAAC,IAAI,CAAC,UAAiB,CAAC,EAAA;;wBAA7E,iBAAiB,GAAG,SAAyD;wBACnF,MAAM,CAAC,MAAM,CAAC,iBAAiB,EAAE;4BAC/B,WAAW,EAAE,EAAE;4BACf,WAAW,EAAE,KAAK;4BAClB,aAAa,EAAE,KAAK;4BACpB,UAAU,EAAE,KAAK;4BACjB,OAAO,EAAE,CAAC,OAAO,EAAE,OAAO,EAAE,QAAQ,CAAC;yBACtC,CAAC,CAAC;wBACU,qBAAM,wBAAgB,CAAC,iBAAiB,CAAC,EAAA;;wBAAtD,UAAU,GAAG,SAAyC,CAAC;wBAC3B,qBAAM,UAAU,CAAC,cAAc,EAAE,EAAA;;wBAAvD,mBAAmB,GAAG,SAAiC;wBAC7D,qBAAM,UAAU,CAAC,KAAK,EAAE,EAAA;;wBAAxB,SAAwB,CAAC;wBAEzB,6DAA6D;wBAC7D,OAAO,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;;;;6BAGtC,UAAU,EAAV,wBAAU;wBAAE,qBAAO,UAAyB,CAAC,KAAK,EAAE,EAAA;;wBAAxC,SAAwC,CAAC;;;wBAEzD,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC,8BAA8B,CAAC,CAAC,CAAC;wBAC/D,OAAO,CAAC,KAAK,CAAC,KAAG,CAAC,CAAC;wBACnB,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;;;;;;KAEnB;IAEH,2BAAC;AAAD,CAlDA,AAkDC,IAAA;AAlDY,oDAAoB","file":"MigrationShowCommand.js","sourcesContent":["import {createConnection} from \"../index\";\r\nimport {ConnectionOptionsReader} from \"../connection/ConnectionOptionsReader\";\r\nimport {Connection} from \"../connection/Connection\";\r\nimport * as process from \"process\";\r\nimport * as yargs from \"yargs\";\r\nconst chalk = require(\"chalk\");\r\n\r\n/**\r\n * Runs migration command.\r\n */\r\nexport class MigrationShowCommand implements yargs.CommandModule {\r\n\r\n  command = \"migration:show\";\r\n  describe = \"Show all migrations and whether they have been run or not\";\r\n\r\n  builder(args: yargs.Argv) {\r\n    return args\r\n      .option(\"connection\", {\r\n        alias: \"c\",\r\n        default: \"default\",\r\n        describe: \"Name of the connection on which run a query.\"\r\n      })\r\n      .option(\"config\", {\r\n        alias: \"f\",\r\n        default: \"ormconfig\",\r\n        describe: \"Name of the file with connection configuration.\"\r\n      });\r\n  }\r\n\r\n  async handler(args: yargs.Arguments) {\r\n    let connection: Connection|undefined = undefined;\r\n    try {\r\n      const connectionOptionsReader = new ConnectionOptionsReader({\r\n        root: process.cwd(),\r\n        configName: args.config as any\r\n      });\r\n      const connectionOptions = await connectionOptionsReader.get(args.connection as any);\r\n      Object.assign(connectionOptions, {\r\n        subscribers: [],\r\n        synchronize: false,\r\n        migrationsRun: false,\r\n        dropSchema: false,\r\n        logging: [\"query\", \"error\", \"schema\"]\r\n      });\r\n      connection = await createConnection(connectionOptions);\r\n      const unappliedMigrations = await connection.showMigrations();\r\n      await connection.close();\r\n\r\n      // return error code if there are unapplied migrations for CI\r\n      process.exit(unappliedMigrations ? 1 : 0);\r\n\r\n    } catch (err) {\r\n      if (connection) await (connection as Connection).close();\r\n\r\n      console.log(chalk.black.bgRed(\"Error during migration show:\"));\r\n      console.error(err);\r\n      process.exit(1);\r\n    }\r\n  }\r\n\r\n}\r\n"],"sourceRoot":".."}